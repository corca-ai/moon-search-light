# Relevance 모듈 - 원칙

> 동기화 대상: `app/features/relevance/principles.ts`

---

## 1. 임베딩 모델 설정

| 항목 | 값 |
|------|-----|
| 모델 | `text-embedding-3-small` |
| 차원 | 1536 |
| 최대 입력 | ~8000자 (토큰 제한 고려) |

---

## 2. API 제한

### 2.1 배치 제한

| 항목 | 값 | 이유 |
|------|-----|------|
| 최대 배치 크기 | 50개 | API 제한 |
| 후보 논문 제한 | 20개 | API 비용 절감 |

### 2.2 디바운스

| 항목 | 값 |
|------|-----|
| 점수 계산 디바운스 | 300ms |

---

## 3. 유사도 계산 규칙

### 3.1 코사인 유사도

- 두 벡터 간의 각도 기반 유사도
- 출력 범위: -1 ~ 1
- 1에 가까울수록 유사

### 3.2 점수 변환

| 단계 | 범위 | 설명 |
|------|------|------|
| 원본 유사도 | -1 ~ 1 | 코사인 유사도 |
| 정규화 | 0 ~ 1 | `(similarity + 1) / 2` |
| 퍼센트 | 0 ~ 100 | `round(normalized * 100)` |

### 3.3 평균 임베딩

- 선택된 논문들의 임베딩 평균 계산
- 후보 논문과 평균 임베딩 비교

---

## 4. 캐싱 규칙

### 4.1 클라이언트 캐시

- **키**: `paperId`
- **값**: 임베딩 벡터 (number[])
- **저장소**: 메모리 (Map)
- **만료**: 세션 종료 시

### 4.2 캐시 전략

1. 요청 전 캐시 확인
2. 캐시 미스만 API 호출
3. 응답 후 캐시 저장

---

## 5. 텍스트 전처리 규칙

### 5.1 임베딩 입력 구성

```
{title}

{abstract}
```

### 5.2 길이 제한

- 최대 8000자로 truncate
- 토큰 제한 초과 방지

---

## 6. 에러 처리 규칙

| 상황 | 대응 |
|------|------|
| API 실패 | 빈 점수 반환 |
| 요청 중단 (AbortError) | 무시 (정상 흐름) |
| 선택 논문 없음 | 빈 점수 반환 |
| 후보 논문 없음 | 빈 점수 반환 |

---

## 7. UI 표시 규칙

### 7.1 점수 표시

- 범위: 0% ~ 100%
- 높을수록 선택 논문과 유사

### 7.2 표시 조건

- 선택된 논문이 1개 이상일 때만 표시
- 계산 중일 때 로딩 표시

---

## 핵심 원칙 요약

1. **비용 최적화**: 후보 20개, 캐싱으로 중복 호출 방지
2. **코사인 유사도**: 방향 기반 유사도 측정
3. **평균 임베딩**: 선택 논문들의 중심점과 비교
4. **퍼센트 변환**: 0-100% 스케일로 직관적 표시
5. **Graceful 에러 처리**: 실패 시 빈 결과 반환

---

> **동기화 지침**: 이 문서를 수정하면 `app/features/relevance/principles.ts`도 함께 수정해야 합니다.
